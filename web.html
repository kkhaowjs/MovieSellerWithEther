<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Sell Web Page</title>
    <link rel="stylesheet" type="text/css" href="main.css">
    <!-- <script src="./node_modules/web3/dist/web3.min.js">
    </script> -->
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.3/dist/web3.min.js"></script>
</head>

<body>
    <header>
        <div class="container">
            Header
        </div>
    </header>

    <main>
        <div class="container">
            <h1>Welcome to MovieLand</h1>
            <div class="movie-container">
                <div class="movie">
                    <img src="image/movie1.jpg" alt="The Platform">
                    <h2>The Platform</h2>
                    <span>2019 | Maturity Rating:18+ | 1h 34m | Thriller</span>
                    <p>A slab of food descends floor by floor in a prison. The inmates above eat heartily, leaving those
                        below starving and desperate. A rebellion is imminent.</p>
                    <button id="document1" onclick="btnPurchase('The Platform',0.5)">- $0.5 ether - Purchase
                        Now</button>
                </div>
                <div class="movie">
                    <img src="image/movie2.jpg" alt="Parasite">
                    <h2>Parasite</h2>
                    <span>2019 | Maturity Rating:16+ | 2h 6m | Comedy</span>
                    <p>One by one, the crafty members of a destitute family insinuate themselves into the household
                        staff of a wealthy couple living in oblivious privilege.</p>
                    <button id="document1" onclick="btnPurchase('Parasite',0.7)">- $0.7 ether - Purchase Now</button>
                </div>
                <div class="movie">
                    <img src="image/movie3.jpg" alt="THE SHALLOWS">
                    <h2>THE SHALLOWS</h2>
                    <span>2016 | Maturity Rating:16+ | 1h 26m | Drama</span>
                    <p>After being bitten by a great white shark, a young surfer is stranded on a rock close to shore
                        and must outwit the predator that stalks nearby.</p>
                    <button id="document1" onclick="btnPurchase('THE SHALLOWS',0.45)">- $0.45 ether - Purchase
                        Now</button>
                </div>
                <div class="movie">
                    <img src="image/movie4.jpg" alt="ADDICTED">
                    <h2>ADDICTED</h2>
                    <span>2014 | Maturity Rating:16+ | 1h 45m | Drama</span>
                    <p>With a caring husband, two kids and a great career, Zoe has it all, until she develops an
                        insatiable hunger for sex with other men.</p>
                    <button id="document1" onclick="btnPurchase('ADDICTED',0.35)">- $0.35 ether - Purchase Now</button>
                </div>
                <div class="movie">
                    <img src="image/movie5.jpg" alt="Bird Box Barcelona">
                    <h2>Bird Box Barcelona</h2>
                    <span>2023 | Maturity Rating:16+ | 1h 51m | Thriller</span>
                    <p>As a mysterious force decimates humanity, a sinister new threat grows in this Barcelona-set film
                        that expands the story of the blockbuster "Bird Box."</p>
                    <button id="document1" onclick="btnPurchase('Bird Box Barcelona',0.5)">- $0.5 ether - Purchase
                        Now</button>
                </div>
                <div class="movie">
                    <img src="image/movie6.jpg" alt="Split">
                    <h2>Split</h2>
                    <span>2016 | Maturity Rating:16+ | 1h 57m | Thriller</span>
                    <p>Three girls are kidnapped by a man with a diagnosed 23 distinct personalities. They must try to
                        escape before the apparent emergence of a frightful new 24th.</p>
                    <button id="document1" onclick="btnPurchase('Split',0.65)">- $0.65 ether - Purchase Now</button>
                </div>
            </div>
        </div>
        <div class="table-container" style="margin-top: 50px;">
            <h1>Buying Table</h1>
            <table>
                <tr>
                    <th>Time</th>
                    <th>Movie</th>
                    <th>Owner</th>
                </tr>
                <tr>
                    <td id="time1"> </td>
                    <td id="movie1"> </td>
                    <td id="owner1"> </td>
                </tr>
                <tr>
                    <td id="time2"> </td>
                    <td id="movie2"> </td>
                    <td id="owner2"> </td>
                </tr>
                <tr>
                    <td id="time3"> </td>
                    <td id="room3"> </td>
                    <td id="owner3"> </td>
                </tr>
                <tr>
                    <td id="time4"> </td>
                    <td id="movie4"> </td>
                    <td id="owner4"> </td>
                </tr>
                <tr>
                    <td id="time5"> </td>
                    <td id="movie5"> </td>
                    <td id="owner5"> </td>
                </tr>
                <tr>
                    <td id="time6"> </td>
                    <td id="movie6"> </td>
                    <td id="owner6"> </td>
                </tr>
            </table>
        </div>
    </main>

    <footer>
        <div class="container">
            Footer
        </div>
    </footer>

    <script src="https://code.jquery.com/jquery-3.7.1.slim.min.js"></script>
    <script>

        // ===Connecting to MetaMask===
        function loadWeb3() {
            if (window.ethereum) {
                web3 = new Web3(window.ethereum);
                ethereum
                    .request({ method: 'eth_requestAccounts' })
                    .then(handleAccountsChanged)
                    .catch((err) => {
                        if (err.code === 4001) {
                            console.log('Please connect to MetaMask.');
                        } else {
                            console.error(err);
                        }
                    });
            } else {
                console.log('MetaMask extension not detected. Please install MetaMask.');
            }
        }

        let currentAccount = null;

        window.ethereum.on('accountsChanged', handleAccountsChanged);

        function handleAccountsChanged(accounts) {
            if (accounts.length === 0) {
                console.log('Please connect to MetaMask.');
            } else if (accounts[0] !== currentAccount) {
                currentAccount = accounts[0];
                console.log('Current account changed:', currentAccount);
            }
        }

        // Contract ABI (Application Binary Interface)
        let abi = [
        {
            "anonymous": false,
            "inputs": [
                {
                    "indexed": false,
                    "internalType": "address",
                    "name": "owner",
                    "type": "address"
                },
                {
                    "indexed": false,
                    "internalType": "string",
                    "name": "movie",
                    "type": "string"
                }
            ],
            "name": "Add",
            "type": "event"
        },
        {
            "inputs": [
                {
                    "internalType": "string",
                    "name": "name",
                    "type": "string"
                }
            ],
            "name": "reserve",
            "outputs": [],
            "stateMutability": "payable",
            "type": "function"
        }
    ];

        // Load Contract
        async function loadContract() {
            return await new web3.eth.Contract(abi, '0x10e8c37183b32B70B1F2A5d9CE24898bFFab0f79');
        }

        async function load() {
            await loadWeb3();
            web3.contract = await loadContract();
            updateStatus('Ready!');
        }

        function updateStatus(status) {
            const statusEl = document.getElementById('status');
            statusEl.innerHTML = status;
            console.log(status);
        }
        var i = 0;
        async function btnPurchase(p, V) {
            console.log(currentAccount);
            window.contract.methods.reserve(p).send({ from: currentAccount, value: v }, function (error, result) {
                $("#result").html(result);
            });
            window.contract.once("Add", {}, function (error, event) {
                if (!error) {
                    console.log(event);
                    var h = new Date().getHours()
                    var m = new Date().getMinutes()
                    $("#result").html("movie:" + event.returnValues.movie + "<br/>time:" + h + ":" + m  + "<br/>owner:" + event.returnValues.owner);
                    i++;
                    $("#time" + i).html(h + ":" + m);
                    $("#movie" + i).html(event.returnValues.movie)
                    $("#owner" + i).html(event.returnValues.owner)
                }
                else{
                    console.log(error)
                }
            })
        };
        load();
    </script>

</body>

</html>